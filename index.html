<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>å¥¶å¥¶çš„éº»å°†</title>
    <style>
        /* åŸºç¡€è®¾ç½® */
        html, body {
            background-color: #0b4d28 !important; width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; user-select: none; -webkit-user-select: none;
        }
        #start-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #start-btn {
            font-size: 28px; padding: 15px 50px; background: #d32f2f; color: white;
            border: 4px solid white; border-radius: 50px; font-weight: bold;
        }
        #debug-console {
            position: fixed; top: 0; left: 0; width: 100%; background: rgba(0,0,0,0.5); 
            color: #ffcccc; font-size: 12px; z-index: 10000; padding: 5px; pointer-events: none; display: none;
        }
        
        /* ç•Œé¢å¸ƒå±€ */
        .header { height: 35px; display: flex; justify-content: flex-end; align-items: center; padding: 0 10px; font-size: 18px; color: gold; background: rgba(0,0,0,0.2); }
        .main-area { flex: 1; display: flex; flex-direction: column; }
        
        .opponents { height: 160px; display: flex; justify-content: space-between; padding: 5px; }
        .opp-box { width: 45%; display: flex; flex-direction: column; align-items: center; position: relative; }
        .opp-name { font-size: 14px; color: #ddd; margin-bottom: 2px; text-shadow: 1px 1px 1px #000; }
        
        .liang-tag { background: #ff9800; color: black; font-weight: bold; font-size: 12px; padding: 1px 4px; border-radius: 3px; margin-left: 5px; display: none; border: 1px solid #fff; }
        
        /* å¬ç‰Œæç¤ºæ¡† */
        .ting-box {
            display: none; flex-wrap: wrap; justify-content: center; background: rgba(0,0,0,0.6); 
            padding: 2px 5px; border-radius: 10px; border: 1px solid #ff9800; margin-bottom: 3px; min-height: 25px; align-items: center;
        }
        .ting-txt { color: #ff9800; font-size: 12px; margin-right: 3px; }

        .opp-hand { background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 8px; font-size: 12px; color: #ccc; }
        .opp-hand-open { display: flex; justify-content: center; flex-wrap: wrap; } 
        .opp-melds { display: flex; height: 32px; justify-content: center; margin-bottom: 2px; }
        .river { width: 95%; height: 75px; background: rgba(0,0,0,0.2); border-radius: 5px; display: flex; flex-wrap: wrap; align-content: flex-start; padding: 2px; margin-top: 2px; }

        .center-stage { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #msg { font-size: 22px; color: white; background: rgba(0,0,0,0.6); padding: 8px 20px; border-radius: 20px; margin-bottom: 10px; text-align: center; }
        #big-card { width: 60px; height: 80px; display: flex; justify-content: center; align-items: center; }

        /* ç©å®¶åŒºåŸŸ */
        .my-area { height: 210px; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 5px; }
        .my-river-box { display: flex; justify-content: center; margin-bottom: 5px; }
        .my-river { width: 60%; height: 60px; background: rgba(0,0,0,0.2); border-radius: 5px; display: flex; flex-wrap: wrap; justify-content: center; padding: 2px; }
        .my-info-row { display: flex; justify-content: center; align-items: center; height: 30px; margin-bottom: 5px; }
        .hand-row { display: flex; justify-content: center; align-items: flex-end; height: 85px; padding: 0 5px; }
        .my-melds { display: flex; margin-right: 10px; }
        .my-hand { display: flex; }

        .btn-layer { position: absolute; bottom: 120px; width: 100%; display: flex; justify-content: center; gap: 15px; pointer-events: none; z-index: 200; }
        .btn { pointer-events: auto; padding: 10px 25px; border-radius: 30px; border: none; font-size: 20px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.5); transition: transform 0.1s;}
        .btn:active { transform: scale(0.9); }
        .btn-hu { background: #d32f2f; color: white; animation: pulse 1s infinite; }
        .btn-peng { background: #1976d2; color: white; }
        .btn-gang { background: #7b1fa2; color: white; }
        .btn-pass { background: #666; color: white; }
        .btn-liang { background: linear-gradient(to bottom, #ffeb3b, #fbc02d); color: black; border: 2px solid white; display: none; }
        .btn-out { background: gold; color: black; display: none; padding: 10px 40px; }
        @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.1);} 100%{transform:scale(1);} }

        /* ç‰Œæ ·å¼ */
        .tile { width: 42px; height: 60px; background: #fff; border-radius: 4px; margin: 1px; position: relative; display: inline-block; box-shadow: 1px 2px 2px rgba(0,0,0,0.3); }
        .tile-face { width: 100%; height: 100%; }
        .tile.selected { transform: translateY(-20px); border: 2px solid gold; background: #ffffe0; }
        .tile-dropped { transform: scale(0.75); margin: -8px -5px; border: 1px solid #999; }
        .tile-meld { transform: scale(0.7); margin: -8px -6px; background: #eef; }
        .tile-big { transform: scale(1.5); box-shadow: 0 0 15px yellow; z-index: 100; background: #fff; }
        .tile-small { transform: scale(0.6); margin: -10px -8px; }
        .tile-tiny { transform: scale(0.5); margin: -15px -10px; background: #fffbe6; border: 1px solid orange; }

        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 5000; }
        .res-box { background: white; color: #333; width: 80%; padding: 20px; border-radius: 10px; text-align: center; }
        .res-score { font-size: 40px; font-weight: bold; color: #d32f2f; margin: 15px 0; }
    </style>
</head>
<body>
    <div id="debug-console"></div>
    <div id="start-layer">
        <button id="start-btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
    </div>
    <div class="header">ğŸ’° <span id="score">10000</span></div>
    <div class="main-area">
        <div class="opponents">
            <div class="opp-box">
                <div class="opp-name">â¬…ï¸ ä¸Šå®¶ <span class="liang-tag" id="tag-2">äº®</span></div>
                <div class="ting-box" id="ting-box-2"><span class="ting-txt">èƒ¡:</span><div id="ting-tiles-2" style="display:flex"></div></div>
                <div class="opp-melds" id="melds-2"></div>
                <div class="opp-hand" id="hand-2">å‰©13å¼ </div>
                <div class="river" id="river-2"></div>
            </div>
            <div class="opp-box">
                <div class="opp-name">ä¸‹å®¶ â¡ï¸ <span class="liang-tag" id="tag-1">äº®</span></div>
                <div class="ting-box" id="ting-box-1"><span class="ting-txt">èƒ¡:</span><div id="ting-tiles-1" style="display:flex"></div></div>
                <div class="opp-melds" id="melds-1"></div>
                <div class="opp-hand" id="hand-1">å‰©13å¼ </div>
                <div class="river" id="river-1"></div>
            </div>
        </div>
        <div class="center-stage">
            <div id="msg">å‡†å¤‡å¼€å§‹</div>
            <div id="big-card"></div>
        </div>
        <div class="my-area">
            <div class="my-river-box"><div class="my-river" id="river-0"></div></div>
            <div class="my-info-row">
                <span class="liang-tag" id="tag-0" style="font-size:16px; padding:5px;">å·²äº®å€’</span>
                <div class="ting-box" id="ting-box-0" style="margin-left:10px; display:none;">
                    <span class="ting-txt">ä½ èƒ¡:</span><div id="ting-tiles-0" style="display:flex"></div>
                </div>
            </div>
            <div class="hand-row">
                <div class="my-melds" id="melds-0"></div>
                <div class="my-hand" id="hand-0"></div>
            </div>
        </div>
    </div>
    <div class="btn-layer" id="btn-box">
        <button class="btn btn-liang" id="btn-liang" onclick="actLiang()">äº®å€’</button>
        <button class="btn btn-gang" id="btn-gang-self" style="display:none" onclick="actGangSelf()">æ </button>
        <button class="btn btn-out" id="btn-out" onclick="actDiscard()">å‡ºç‰Œ</button>
    </div>
    <div class="modal" id="modal">
        <div class="res-box">
            <h2 id="res-title">èƒ¡ç‰Œå•¦</h2>
            <div id="res-desc">å¡äº”æ˜Ÿ</div>
            <div class="res-score" id="res-score">+3200</div>
            <button class="btn" style="background:#388e3c; color:white; padding:10px 30px;" onclick="startGame()">å†æ¥ä¸€å±€</button>
        </div>
    </div>

<script>
    // é”™è¯¯å¤„ç†
    var debug = document.getElementById('debug-console');
    window.onerror = function(msg, url, line) {
        debug.style.display = 'block'; debug.innerHTML += "Err: " + msg + " (L" + line + ")<br>"; return false;
    };

    // --- ç»˜å›¾å¼•æ“ (ä¿®å¤ç™½æ¿) ---
    var COLORS = { b: "#0055aa", g: "#008800", r: "#cc0000" };
    function getSvg(val) {
        var svg = '<svg viewBox="0 0 100 130" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">';
        if (val >= 0 && val <= 8) svg += drawTong(val + 1);
        else if (val >= 9 && val <= 17) svg += drawTiao(val - 8);
        else if (val === 18) svg += txt("ä¸­", COLORS.r);
        else if (val === 19) svg += txt("ç™¼", COLORS.g);
        else if (val === 20) {
            // ä¿®å¤ï¼šç™½æ¿ç”»æˆåŒå±‚è“æ¡†ï¼Œæ›´é†’ç›®
            svg += '<rect x="15" y="20" width="70" height="90" fill="none" stroke="'+COLORS.b+'" stroke-width="6" rx="5"/>';
            svg += '<rect x="25" y="30" width="50" height="70" fill="none" stroke="'+COLORS.b+'" stroke-width="2" rx="3"/>';
        }
        svg += '</svg>'; return svg;
    }
    function txt(t,c){return '<text x="50" y="80" font-size="60" fill="'+c+'" text-anchor="middle" font-weight="bold">'+t+'</text>';}
    function drawTong(n) {
        if(n===1) return cir(50,65,COLORS.r,35)+cir(50,65,'#fff',15)+cir(50,65,COLORS.r,8);
        if(n===7) return cir(20,30,COLORS.g)+cir(50,40,COLORS.g)+cir(80,50,COLORS.g)+cir(30,80,COLORS.r)+cir(70,80,COLORS.r)+cir(30,110,COLORS.r)+cir(70,110,COLORS.r);
        var p=[];
        if(n===2)p=[[50,35],[50,95]];if(n===3)p=[[25,30],[50,65],[75,100]];if(n===4)p=[[25,35],[75,35],[25,95],[75,95]];
        if(n===5)p=[[25,35],[75,35],[50,65],[25,95],[75,95]];if(n===6)p=[[25,35],[75,35],[25,65],[75,65],[25,95],[75,95]];
        if(n===8)p=[[25,25],[75,25],[25,50],[75,50],[25,75],[75,75],[25,100],[75,100]];
        if(n===9)p=[[20,25],[50,25],[80,25],[20,65],[50,65],[80,65],[20,105],[50,105],[80,105]];
        var h=""; for(var i=0;i<p.length;i++) h+=cir(p[i][0],p[i][1],(n===5&&i===2||n===3&&i===1)?COLORS.r:COLORS.b,(n===9?11:13)); return h;
    }
    function cir(x,y,c,r){return '<circle cx="'+x+'" cy="'+y+'" r="'+(r||12)+'" fill="'+c+'"/>';}
    function drawTiao(n){
        if(n===1)return '<path d="M50,30 Q70,30 75,50 Q80,70 50,70 Q30,70 30,50 Q30,30 50,30 M50,45 Q55,45 55,50 M35,60 L65,60 M50,70 L50,100 M40,100 L60,100" stroke="'+COLORS.g+'" stroke-width="3" fill="none"/>';
        var h=""; 
        if(n===2)h=rec(45,20,COLORS.g)+rec(45,70,COLORS.b);
        if(n===3)h=rec(25,20,COLORS.g)+rec(45,50,COLORS.r)+rec(65,80,COLORS.g);
        if(n===4)h=rec(30,20,COLORS.g)+rec(60,20,COLORS.g)+rec(30,70,COLORS.b)+rec(60,70,COLORS.b);
        if(n===5)h=rec(20,20,COLORS.g)+rec(70,20,COLORS.g)+rec(45,50,COLORS.r)+rec(20,80,COLORS.b)+rec(70,80,COLORS.b);
        if(n===6){for(var i=0;i<3;i++)h+=rec(30+i*20,30,COLORS.g)+rec(30+i*20,70,COLORS.b);}
        if(n===8){for(var i=0;i<4;i++)h+=rec(20+i*18,20,COLORS.g)+rec(20+i*18,80,COLORS.b);}
        if(n===7){for(var i=0;i<3;i++)h+=rec(30+i*20,20,COLORS.g);for(var i=0;i<4;i++)h+=rec(20+i*18,70,COLORS.g);}
        if(n===9){for(var j=0;j<3;j++)for(var i=0;i<3;i++)h+=rec(30+i*20,15+j*35,j===1?COLORS.r:(j===0?COLORS.g:COLORS.b),6,25);} return h;
    }
    function rec(x,y,c,w,h){return '<rect x="'+x+'" y="'+y+'" width="'+(w||8)+'" height="'+(h||30)+'" fill="'+c+'"/>';}

    // --- æ¸¸æˆé€»è¾‘ ---
    var G = { deck:[], ps:[], turn:0, last:-1, from:-1, sel:-1, drawn:false, gangInfo:null };

    function startGame() {
        try {
            document.getElementById('start-layer').style.display = 'none';
            document.getElementById('modal').style.display = 'none';
            resetData(); render(); updateScoreUI();
            setMsg("æ¸¸æˆå¼€å§‹ï¼Œåº„å®¶æ‘¸ç‰Œ"); setTimeout(drawCard, 500);
        } catch(e) { alert("å¯åŠ¨æŠ¥é”™: " + e.message); }
    }

    function resetData() {
        hideActs();
        G.deck=[]; for(var i=0;i<=20;i++) for(var k=0;k<4;k++) G.deck.push(i);
        for(var i=G.deck.length-1;i>0;i--) { var j=Math.floor(Math.random()*(i+1)); var t=G.deck[i]; G.deck[i]=G.deck[j]; G.deck[j]=t; }
        if(G.ps.length===0) for(var i=0;i<3;i++) G.ps.push({ score:10000 });
        for(var i=0;i<3;i++) {
            G.ps[i].hand = []; G.ps[i].meld = []; G.ps[i].river = []; G.ps[i].liang = false; G.ps[i].ting = [];
            for(var m=0;m<13;m++) G.ps[i].hand.push(G.deck.pop());
            G.ps[i].hand.sort(function(a,b){return a-b});
        }
        G.turn = 0; G.drawn = false; G.sel = -1;
    }

    function drawCard() {
        if(G.deck.length==0) { alert("æµå±€"); startGame(); return; }
        var p = G.ps[G.turn]; var c = G.deck.pop(); p.hand.push(c);
        if(G.turn == 0) { 
            G.drawn = true; G.sel = -1; render();
            // äº®å€’åé€»è¾‘
            if(p.liang) {
                setMsg("å·²äº®å€’ï¼šè¯·æ‰“å‡ºåˆšæ‘¸çš„ç‰Œ");
                if(checkWin(p.hand, p.meld)) { showActs(['HU','PASS']); setMsg("äº®å€’è‡ªæ‘¸ï¼"); }
                return;
            }
            // æ­£å¸¸é€»è¾‘
            if(checkWin(p.hand, p.meld)) { showActs(['HU','PASS']); setMsg("æ‘¸åˆ°å¥½ç‰Œï¼"); } 
            else {
                setMsg("è¯·å‡ºç‰Œ");
                if(checkCanLiang(p.hand, p.meld)) document.getElementById('btn-liang').style.display='block';
                var g = checkGang(p);
                if(g) { G.gangInfo=g; document.getElementById('btn-gang-self').style.display='block'; }
            }
        } else { // ç”µè„‘
            render(); setMsg((G.turn==1?"ä¸‹å®¶":"ä¸Šå®¶")+"æ€è€ƒä¸­...");
            setTimeout(function(){ aiPlay(p); }, 800);
        }
    }

    // ä¿®å¤ï¼šä¸¥æ ¼æŸ¥å¬é€»è¾‘ (éå†æ‰‹ç‰Œï¼Œå‡è®¾æ‰“å‡ºæ¯ä¸€å¼ ï¼Œçœ‹å‰©ä¸‹13å¼ æ˜¯å¦å¬ç‰Œ)
    function checkCanLiang(hand14, melds) {
        for(var i=0; i<hand14.length; i++) {
            var temp = hand14.slice();
            temp.splice(i, 1); // æ¨¡æ‹Ÿæ‰“å‡ºè¿™å¼ 
            var tings = getWinTiles(temp, melds);
            if(tings.length > 0) return true; // åªè¦èƒ½å¬ï¼Œå°±å…è®¸äº®
        }
        return false;
    }

    function getWinTiles(h13, m) {
        var wins = [];
        for(var t=0;t<=20;t++) {
            var test = h13.slice(); test.push(t); test.sort(function(a,b){return a-b});
            if(checkWin(test, m)) wins.push(t);
        }
        return wins;
    }

    function aiPlay(p) {
        if(checkWin(p.hand, p.meld)) { showResult(false, "ç”µè„‘èƒ¡äº†", -500, "è‡ªæ‘¸"); return; }
        
        if(!p.liang) {
            for(var i=0; i<p.hand.length; i++) {
                var temp = p.hand.slice();
                var cardToDiscard = temp.splice(i, 1)[0];
                var tings = getWinTiles(temp, p.meld);
                if(tings.length > 0 && Math.random()<0.8) {
                    p.liang = true; p.ting = tings;
                    p.hand = temp; G.last = cardToDiscard; G.from = G.turn; G.drawn = false;
                    showBig(cardToDiscard); render(); checkResp();
                    return;
                }
            }
        }
        if(p.liang) { var c = p.hand.pop(); playCard(c); return; }
        
        var danger = []; if(G.ps[0].liang) danger = G.ps[0].ting;
        var counts={}; for(var i=0;i<p.hand.length;i++) counts[p.hand[i]]=(counts[p.hand[i]]||0)+1;
        var best = -1;
        for(var i=0; i<p.hand.length; i++) {
            var t = p.hand[i];
            if(danger.indexOf(t) === -1) {
                if(counts[t] === 1) { if(t>=18) { best=i; break; } if(best===-1) best=i; }
            }
        }
        if(best===-1) best = Math.floor(Math.random()*p.hand.length);
        var c = p.hand.splice(best, 1)[0]; p.hand.sort(function(a,b){return a-b});
        playCard(c);
    }

    function playCard(c) {
        G.last = c; G.from = G.turn; G.drawn = false;
        showBig(c); render(); checkResp();
    }

    function checkResp() {
        var c = G.last;
        if(G.from != 0) {
            var p = G.ps[0]; var acts = [];
            var tmp = p.hand.slice(); tmp.push(c); tmp.sort(function(a,b){return a-b});
            if(checkWin(tmp, p.meld)) acts.push('HU');
            if(!p.liang) {
                var cnt=0; for(var i=0;i<p.hand.length;i++) if(p.hand[i]==c) cnt++;
                if(cnt>=2) acts.push('PENG'); if(cnt==3) acts.push('GANG');
            }
            if(acts.length>0) { acts.push('PASS'); showActs(acts); setMsg("æœ‰æ“ä½œ"); return; }
        }
        var n1 = (G.from+1)%3; if(aiResp(n1, c)) return;
        var n2 = (G.from+2)%3; if(aiResp(n2, c)) return;
        G.ps[G.from].river.push(c); nextTurn();
    }

    function aiResp(id, c) {
        if(id==0 || id==G.from) return false;
        var p = G.ps[id];
        var tmp = p.hand.slice(); tmp.push(c); tmp.sort(function(a,b){return a-b});
        if(checkWin(tmp, p.meld)) { showResult(false, "ç”µè„‘èƒ¡äº†", -800, "æ‰ç‚®"); return true; }
        if(p.liang) return false;
        var cnt=0; for(var i=0;i<p.hand.length;i++) if(p.hand[i]==c) cnt++;
        if(cnt==3) { aiAct(id, 'gang', c); return true; }
        if(cnt>=2 && Math.random()<0.6) { aiAct(id, 'peng', c); return true; }
        return false;
    }

    function aiAct(id, type, c) {
        var p = G.ps[id];
        rem(p.hand, c, (type=='gang'?3:2)); p.meld.push({v:c, t:type});
        G.turn = id; document.getElementById('big-card').innerHTML='';
        setMsg("ç”µè„‘"+(type=='gang'?"æ ":"ç¢°")); render();
        if(type=='gang') setTimeout(drawCard, 800);
        else setTimeout(function(){
            var dc = p.hand.splice(0,1)[0]; p.hand.sort(function(a,b){return a-b}); playCard(dc);
        }, 800);
    }

    function nextTurn() {
        document.getElementById('big-card').innerHTML='';
        G.turn = (G.turn+1)%3; render(); setTimeout(drawCard, 500);
    }

    function actDiscard() {
        if(G.sel == -1) return;
        var p = G.ps[0];
        if(p.liang && G.sel != p.hand.length-1) { setMsg("äº®å€’è§„åˆ™ï¼šåªèƒ½æ‰“åˆšæ‘¸çš„ç‰Œï¼"); return; }
        
        var c = p.hand.splice(G.sel, 1)[0];
        p.hand.sort(function(a,b){return a-b});
        
        // å¦‚æœæ˜¯ä»actLiangæ¥çš„ï¼Œè¿™é‡Œç¡®è®¤äº®å€’
        if(G.pendingLiang) {
            p.liang = true;
            G.pendingLiang = false;
            // è®¡ç®—æ‰“å‡ºè¿™å¼ ç‰Œåå¬ä»€ä¹ˆï¼Œå¹¶æ˜¾ç¤º
            p.ting = getWinTiles(p.hand, p.meld); 
        }
        
        hideActs(); playCard(c);
    }
    
    function actLiang() {
        // ç‚¹å‡»äº®å€’åï¼Œä¸ç«‹å³äº®ï¼Œè€Œæ˜¯æ ‡è®°â€œæ­£åœ¨äº®å€’â€ï¼Œè®©ç”¨æˆ·é€‰ä¸€å¼ ç‰Œæ‰“å‡ºå»
        G.pendingLiang = true;
        setMsg("è¯·æ‰“å‡ºä¸€å¼ ç‰Œä»¥äº®å€’");
        hideActs();
        document.getElementById('btn-out').style.display='block';
    }
    
    function actGangSelf() {
        var p = G.ps[0]; var g = G.gangInfo;
        if(g.type=='an') { rem(p.hand, g.v, 4); p.meld.push({v:g.v, t:'gang'}); }
        else { rem(p.hand, g.v, 1); for(var i=0;i<p.meld.length;i++) if(p.meld[i].v==g.v) p.meld[i].t='gang'; }
        G.gangInfo=null; hideActs(); render(); setTimeout(drawCard, 500);
    }
    function doAct(a) {
        hideActs(); document.getElementById('big-card').innerHTML='';
        var p = G.ps[0]; var c = G.last;
        if(a=='PASS') {
            if(p.liang && G.turn==0) { var dc = p.hand.pop(); p.hand.sort(function(a,b){return a-b}); playCard(dc); } 
            else { G.ps[G.from].river.push(c); nextTurn(); }
        }
        else if(a=='HU') { 
            var score = 1000; if(p.liang) score *= 2; 
            if((c==4||c==13) && p.hand.indexOf(c-1)>-1 && p.hand.indexOf(c+1)>-1) score *= 2;
            showResult(true, "èƒ¡ç‰Œå•¦", score, p.liang?"äº®å€’":"å¹³èƒ¡"); 
        }
        else if(a=='PENG') { rem(p.hand,c,2); p.meld.push({v:c,t:'peng'}); G.turn=0; G.drawn=true; G.sel=-1; setMsg("ç¢°ï¼Œè¯·å‡ºç‰Œ"); document.getElementById('btn-liang').style.display='none'; render(); }
        else if(a=='GANG') { rem(p.hand,c,3); p.meld.push({v:c,t:'gang'}); G.turn=0; setMsg("æ ï¼Œæ‘¸ä¸€å¼ "); setTimeout(drawCard,500); }
    }

    function clk(idx) {
        if(G.turn!=0 || !G.drawn) return;
        var p = G.ps[0];
        if(p.liang && idx !== p.hand.length - 1) { setMsg("äº®å€’ååªèƒ½æ“ä½œæ–°æ‘¸çš„ç‰Œ"); return; }
        var realIdx = (p.liang || (G.turn==0&&G.drawn)) && idx == p.hand.length-1 ? idx : idx;
        if(G.sel == realIdx) actDiscard();
        else { G.sel = realIdx; render(); document.getElementById('btn-out').style.display='block'; }
    }

    // ä¿®å¤åçš„ç®—æ³•ï¼šä¸¥æ ¼æ£€æŸ¥å‰©ä½™å¼ æ•°ï¼Œé˜²æ­¢è¯¯åˆ¤
    function checkWin(h, m) {
        if(m.length==0 && h.length==14 && is7(h)) return true;
        var c={}; for(var i=0;i<h.length;i++) c[h[i]]=(c[h[i]]||0)+1;
        var pair=[]; for(var k in c) if(c[k]>=2) pair.push(parseInt(k));
        for(var i=0;i<pair.length;i++) { 
            var cp = h.slice(); 
            // ä¸¥æ ¼ç§»é™¤ä¸€å¯¹
            if(removeOne(cp, pair[i]) && removeOne(cp, pair[i])) {
                if(isHu(cp)) return true;
            }
        }
        return false;
    }
    function is7(h){ for(var i=0;i<14;i+=2) if(h[i]!=h[i+1]) return false; return true; }
    
    // é€’å½’æ£€æŸ¥èƒ¡ç‰Œ (ä¿®å¤ç‰ˆ)
    function isHu(t) {
        if(t.length==0) return true;
        var f=t[0];
        
        // åˆ»å­æ£€æŸ¥
        var cnt=0; for(var i=0;i<t.length;i++) if(t[i]==f) cnt++;
        if(cnt>=3) { 
            var cp=t.slice(); 
            if(removeOne(cp,f) && removeOne(cp,f) && removeOne(cp,f)) {
                if(isHu(cp)) return true; 
            }
        }
        
        // é¡ºå­æ£€æŸ¥
        if(f<18) {
            if(t.indexOf(f+1)>-1 && t.indexOf(f+2)>-1) {
                // è·¨èŠ±è‰²æ£€æŸ¥
                if(Math.floor(f/9) == Math.floor((f+2)/9)) {
                    var cp=t.slice(); 
                    if(removeOne(cp,f) && removeOne(cp,f+1) && removeOne(cp,f+2)) {
                        if(isHu(cp)) return true;
                    }
                }
            }
        }
        return false;
    }
    
    // å·¥å…·ï¼šç²¾ç¡®ç§»é™¤ä¸€ä¸ªå…ƒç´ 
    function removeOne(arr, v) {
        var idx = arr.indexOf(v);
        if(idx > -1) { arr.splice(idx, 1); return true; }
        return false;
    }
    
    // æ—§çš„remå‡½æ•°æ”¹ä¸ºæ‰¹é‡ç§»é™¤
    function rem(a,v,n) { for(var i=0;i<n;i++) removeOne(a, v); }
    
    function checkGang(p) {
        var c={}; for(var i=0;i<p.hand.length;i++) c[p.hand[i]]=(c[p.hand[i]]||0)+1;
        for(var k in c) if(c[k]==4) return {type:'an', v:parseInt(k)};
        for(var i=0;i<p.hand.length;i++) for(var m=0;m<p.meld.length;m++) if(p.meld[m].t=='peng' && p.meld[m].v==p.hand[i]) return {type:'bu', v:p.hand[i]};
        return null;
    }

    // æ¸²æŸ“
    function render() {
        document.getElementById('score').innerText = G.ps[0].score;
        renderP(0, 'melds-0', 'hand-0', 'river-0', 'tag-0', 'ting-box-0', 'ting-tiles-0');
        renderP(1, 'melds-1', 'hand-1', 'river-1', 'tag-1', 'ting-box-1', 'ting-tiles-1');
        renderP(2, 'melds-2', 'hand-2', 'river-2', 'tag-2', 'ting-box-2', 'ting-tiles-2');
    }
    function renderP(id, mId, hId, rId, tagId, tBoxId, tTilesId) {
        var p = G.ps[id];
        var mH=""; for(var i=0;i<p.meld.length;i++) {
            var n=p.meld[i].t=='gang'?4:3; for(var k=0;k<n;k++) mH+=div(p.meld[i].v, 'tile-meld');
            mH+='<div style="width:5px"></div>';
        }
        document.getElementById(mId).innerHTML = mH;
        var rH=""; for(var i=0;i<p.river.length;i++) rH+=div(p.river[i], 'tile-dropped');
        document.getElementById(rId).innerHTML = rH;
        
        if(tagId) document.getElementById(tagId).style.display = p.liang?'inline-block':'none';
        
        var tEl = document.getElementById(tBoxId);
        if(p.liang || (id==0 && p.liang)) {
            var tings = p.ting.length>0 ? p.ting : (id==0 && p.liang ? getWinTiles(p.hand, p.meld) : []);
            if(tings.length>0) {
                tEl.style.display='flex';
                var tH=""; for(var w=0;w<tings.length;w++) tH+=div(tings[w], 'tile-tiny');
                document.getElementById(tTilesId).innerHTML = tH;
            } else tEl.style.display='none';
        } else tEl.style.display='none';

        var hEl = document.getElementById(hId);
        if(id==0 || p.liang) {
            hEl.className = id==0?'my-hand':'opp-hand-open';
            var hH=""; var len = p.hand.length - (id==0&&G.turn==0&&G.drawn ? 1 : 0);
            for(var i=0;i<len;i++) hH+=divClick(p.hand[i], i==G.sel, i, id!=0);
            if(id==0&&G.turn==0&&G.drawn) hH+='<div style="width:15px"></div>'+divClick(p.hand[p.hand.length-1], (p.hand.length-1)==G.sel, p.hand.length-1, false);
            hEl.innerHTML = hH;
        } else { hEl.className = 'opp-hand'; hEl.innerHTML = "å‰©"+p.hand.length+"å¼ "; }
    }
    
    function div(v, cls) { return '<div class="tile '+cls+'"><div class="tile-face">'+getSvg(v)+'</div></div>'; }
    function divClick(v, sel, idx, isSmall) { return '<div class="tile '+(sel?'selected':'')+' '+(isSmall?'tile-small':'')+'" onclick="clk('+idx+')"><div class="tile-face">'+getSvg(v)+'</div></div>'; }
    function hideActs() { 
        var box=document.getElementById('btn-box'); box.innerHTML=''; 
        box.innerHTML='<button class="btn btn-liang" id="btn-liang" onclick="actLiang()">äº®å€’</button><button class="btn btn-gang" id="btn-gang-self" style="display:none" onclick="actGangSelf()">æ </button><button class="btn btn-out" id="btn-out" onclick="actDiscard()">å‡ºç‰Œ</button>';
    }
    function showActs(list) {
        var box = document.getElementById('btn-box'); box.innerHTML='';
        for(var i=0;i<list.length;i++) {
            (function(a){
                var b=document.createElement('button');
                b.className='btn btn-'+a.toLowerCase();
                b.innerText = (a=='HU'?"èƒ¡":(a=='PENG'?"ç¢°":(a=='GANG'?"æ ":(a=='PASS'?"è¿‡":""))));
                if(a=='PASS' && G.ps[0].liang) { b.innerText="æ‰“å‡º"; b.className+=' btn-pass'; }
                b.onclick=function(){doAct(a)}; box.appendChild(b);
            })(list[i]);
        }
    }
    function setMsg(t) { document.getElementById('msg').innerText=t; }
    function updateScoreUI() { document.getElementById('score').innerText = G.ps[0].score; }
    function showResult(win, title, score, desc) {
        var m = document.getElementById('modal'); m.style.display='flex';
        document.getElementById('res-title').innerText = title;
        document.getElementById('res-desc').innerText = desc;
        var s = document.getElementById('res-score');
        s.innerText = (score>0?"+":"")+score; s.style.color = score>0?"#d32f2f":"#388e3c";
        G.ps[0].score += score; updateScoreUI();
    }
    function showBig(v) { document.getElementById('big-card').innerHTML = div(v, 'tile-big'); }
    if(window.plus){plusReady();}else{document.addEventListener('plusready',plusReady,false);}
    function plusReady(){plus.navigator.closeSplashscreen();plus.screen.lockOrientation("portrait-primary");}
</script>
</body>
</html>
