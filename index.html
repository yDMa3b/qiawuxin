<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>å¥¶å¥¶çš„å¡äº”æ˜Ÿï¼ˆå¤§å¸ˆè§„åˆ™ç‰ˆï¼‰</title>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body {
            background-color: #0b4d28; color: white; font-family: sans-serif;
            margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column;
            user-select: none; -webkit-user-select: none; overscroll-behavior: none;
        }
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        #start-btn {
            padding: 20px 60px; font-size: 32px; background: #d32f2f; color: white;
            border: 4px solid #fff; border-radius: 50px; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        /* --- éº»å°†ç‰Œ --- */
        .tile {
            width: 44px; height: 64px; background: #fff; border-radius: 4px;
            box-shadow: 1px 2px 2px rgba(0,0,0,0.3), inset 0 0 0 1px #999;
            position: relative; cursor: pointer; margin: 1px; flex-shrink: 0; display: inline-block;
        }
        .tile-face { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .tile.selected { transform: translateY(-15px); background: #fffbe6; border: 2px solid yellow; }
        .tile-dropped { transform: scale(0.75); margin: -8px -6px; border: 1px solid #ccc; }
        .tile-meld { transform: scale(0.65); margin: -8px -6px; background: #eef; }
        .tile-big { transform: scale(1.6); box-shadow: 0 0 15px yellow; z-index: 50; background: #fff; }
        .tile-small-face { transform: scale(0.6); margin: -10px -8px; }
        
        /* å¬ç‰Œæç¤ºçš„å°ç‰Œ */
        .tile-tiny { transform: scale(0.5); margin: -15px -10px; border: 1px solid gold; background: #fffbe6; }

        /* --- å¸ƒå±€ --- */
        .header { height: 30px; display: flex; justify-content: flex-end; align-items: center; padding: 5px 10px; font-size: 18px; color: #ffd700; background: rgba(0,0,0,0.2); }
        .opponents { flex: 1; display: flex; justify-content: space-between; padding: 5px; }
        .opp-box { width: 45%; display: flex; flex-direction: column; align-items: center; position: relative; }
        .opp-name { font-size: 14px; color: #ccc; margin-bottom: 2px; text-shadow: 1px 1px 1px #000; }
        
        .liang-tag {
            background: #ff9800; color: #000; font-weight: bold; font-size: 12px;
            padding: 1px 4px; border-radius: 3px; margin-left: 5px; display: none;
            box-shadow: 0 0 5px red; animation: blink 2s infinite;
        }
        @keyframes blink { 0%{opacity:1;} 50%{opacity:0.6;} 100%{opacity:1;} }

        /* AIèƒ¡ç‰Œæç¤ºåŒº */
        .ting-hint-box {
            display: flex; height: 30px; background: rgba(0,0,0,0.5); 
            border-radius: 15px; align-items: center; padding: 0 10px; margin-bottom: 2px;
            border: 1px solid #ff9800; display: none; /* é»˜è®¤éšè— */
        }
        .ting-label { font-size: 12px; color: #ff9800; margin-right: 5px; white-space: nowrap;}
        
        .opp-hand { background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px; font-size: 12px; min-height: 20px;}
        .opp-hand-open { display: flex; justify-content: center; flex-wrap: wrap; width: 100%; }
        .opp-melds-area { display: flex; height: 40px; margin-bottom: 2px; justify-content: center;}
        
        .river {
            background: rgba(0,0,0,0.15); border-radius: 6px; width: 95%; height: 85px;
            display: flex; flex-wrap: wrap; align-content: flex-start; padding: 2px;
        }
        .center-stage { flex: 1.2; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #msg-text {
            font-size: 22px; color: #fff; text-shadow: 1px 1px 2px #000;
            background: rgba(0,0,0,0.6); padding: 8px 20px; border-radius: 20px; margin-bottom: 10px;
        }
        .big-tile-slot { height: 70px; width: 50px; display: flex; justify-content: center; align-items: center; }
        
        .player-stage { flex: 2; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 5px; }
        .my-river-box { display: flex; justify-content: center; margin-bottom: 5px; }
        .my-river { width: 65%; height: 60px; background: rgba(0,0,0,0.15); border-radius: 6px; display: flex; flex-wrap: wrap; justify-content: center; padding: 2px; }
        .my-hand-row { display: flex; justify-content: center; align-items: flex-end; height: 80px; padding: 0 5px; }
        .my-melds-area { display: flex; margin-right: 10px; } 
        .new-tile-group { margin-left: 15px; border-left: 1px solid rgba(255,255,255,0.2); padding-left: 5px;}
        .my-info { position: absolute; bottom: 90px; left: 10px; }
        
        /* æŒ‰é’® */
        .btn-layer {
            position: absolute; bottom: 100px; width: 100%;
            display: flex; justify-content: center; gap: 10px; pointer-events: none; z-index: 100;
        }
        .btn {
            pointer-events: auto; border: none; border-radius: 40px;
            padding: 10px 20px; font-size: 20px; font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5); transform: scale(1); transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.9); }
        .btn-hu { background: #d32f2f; color: white; animation: pulse 0.8s infinite; }
        .btn-peng { background: #1976d2; color: white; }
        .btn-gang { background: #7b1fa2; color: white; }
        .btn-pass { background: #757575; color: white; }
        .btn-liang { background: linear-gradient(to bottom, #ffeb3b, #fbc02d); color: #333; display: none; border: 2px solid #fff;}
        .btn-out { background: #fbc02d; color: #333; display: none; padding: 10px 40px;}
        
        @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.1);} 100%{transform:scale(1);} }

        .modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); display: none;
            flex-direction: column; justify-content: center; align-items: center; z-index: 2000;
        }
        .result-card { background: white; color: #333; width: 85%; padding: 20px; border-radius: 10px; text-align: center; }
        .res-score { font-size: 40px; font-weight: bold; color: #d32f2f; margin: 15px 0; }
        .res-btn { padding: 12px 35px; background: #388e3c; color: white; border: none; border-radius: 30px; font-size: 22px;}
        #error-log { position: fixed; top: 0; left: 0; background: red; color: white; z-index: 10000; font-size: 12px; display: none; }
    </style>
</head>
<body>
    <div id="error-log"></div>
    <div id="start-overlay">
        <button id="start-btn" onclick="initGameSafe()">ç‚¹æˆ‘å¼€å§‹æ¸¸æˆ</button>
    </div>

    <div class="header">ğŸ’° <span id="my-score">10000</span></div>

    <div class="opponents">
        <!-- ä¸Šå®¶ -->
        <div class="opp-box">
            <div class="opp-name">â¬…ï¸ ç”µè„‘ä¸Šå®¶ <span class="liang-tag" id="p2-liang-tag">äº®</span></div>
            <!-- AIå¬ç‰Œæç¤º -->
            <div class="ting-hint-box" id="p2-ting-box">
                <span class="ting-label">èƒ¡:</span>
                <div id="p2-ting-tiles" style="display:flex;"></div>
            </div>
            <div class="opp-melds-area" id="p2-melds"></div>
            <div class="opp-hand" id="p2-hand-area">å‰©13å¼ </div>
            <div class="river" id="p2-river"></div>
        </div>
        <!-- ä¸‹å®¶ -->
        <div class="opp-box">
            <div class="opp-name">ç”µè„‘ä¸‹å®¶ â¡ï¸ <span class="liang-tag" id="p1-liang-tag">äº®</span></div>
            <div class="ting-hint-box" id="p1-ting-box">
                <span class="ting-label">èƒ¡:</span>
                <div id="p1-ting-tiles" style="display:flex;"></div>
            </div>
            <div class="opp-melds-area" id="p1-melds"></div>
            <div class="opp-hand" id="p1-hand-area">å‰©13å¼ </div>
            <div class="river" id="p1-river"></div>
        </div>
    </div>

    <div class="center-stage">
        <div id="msg-text">è¯·ç‚¹å‡»å¼€å§‹...</div>
        <div class="big-tile-slot" id="big-card"></div>
    </div>

    <div class="my-info">
        <span class="liang-tag" id="my-liang-tag" style="display:none; font-size:16px; padding:5px; background:red; color:white;">å·²äº®å€’ (åªèƒ½æ‘¸æ‰“)</span>
    </div>

    <div class="btn-layer" id="btn-group">
        <button class="btn btn-liang" id="btn-liang" onclick="userLiang()">äº®å€’</button>
        <button class="btn btn-gang" id="btn-self-gang" style="display:none;" onclick="userSelfGang()">æ </button>
        <button class="btn btn-out" id="btn-out" onclick="userDiscard()">å‡ºç‰Œ</button>
    </div>

    <div class="player-stage">
        <div class="my-river-box"><div class="my-river" id="my-river"></div></div>
        <div class="my-hand-row">
            <div class="my-melds-area" id="my-melds"></div>
            <div id="my-hand" style="display:flex;"></div>
            <div class="new-tile-group" id="my-new"></div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="result-card">
            <h2 id="res-title">èƒ¡ç‰Œå•¦</h2>
            <div id="res-desc">å¡äº”æ˜Ÿ</div>
            <div class="res-score" id="res-score">+3200</div>
            <button class="res-btn" onclick="initGameSafe()">å†æ¥ä¸€å±€</button>
        </div>
    </div>

<script>
    // é”™è¯¯æ•è·
    window.onerror = function(msg, url, line) {
        var el = document.getElementById('error-log');
        el.style.display = 'block'; el.innerText = "Err: " + msg + " (" + line + ")";
        return false;
    };

    // --- ç»˜å›¾å¼•æ“ ---
    var COLORS = { blue: "#0055aa", green: "#008800", red: "#cc0000" };
    function getSvg(val) {
        var svg = '<svg viewBox="0 0 100 130" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">';
        if (val >= 0 && val <= 8) svg += drawTong(val + 1);
        else if (val >= 9 && val <= 17) svg += drawTiao(val - 8);
        else if (val === 18) svg += '<text x="50" y="80" font-size="60" fill="'+COLORS.red+'" text-anchor="middle" font-weight="bold">ä¸­</text>';
        else if (val === 19) svg += '<text x="50" y="80" font-size="60" fill="'+COLORS.green+'" text-anchor="middle" font-weight="bold">ç™¼</text>';
        else if (val === 20) svg += '<rect x="15" y="20" width="70" height="90" fill="none" stroke="'+COLORS.blue+'" stroke-width="4" rx="5" />';
        svg += '</svg>';
        return svg;
    }
    function drawTong(n) {
        var c = "";
        if (n===1) return '<circle cx="50" cy="65" r="35" fill="'+COLORS.red+'" /><circle cx="50" cy="65" r="15" fill="#fff" /><circle cx="50" cy="65" r="8" fill="'+COLORS.red+'" />';
        var pos = [];
        if(n===2) pos=[[50,35],[50,95]];
        if(n===3) pos=[[25,30],[50,65],[75,100]];
        if(n===4) pos=[[25,35],[75,35],[25,95],[75,95]];
        if(n===5) pos=[[25,35],[75,35],[50,65],[25,95],[75,95]];
        if(n===6) pos=[[25,35],[75,35],[25,65],[75,65],[25,95],[75,95]];
        if(n===8) pos=[[25,25],[75,25],[25,50],[75,50],[25,75],[75,75],[25,100],[75,100]];
        if(n===9) pos=[[20,25],[50,25],[80,25], [20,65],[50,65],[80,65], [20,105],[50,105],[80,105]];
        if(n===7) return '<circle cx="20" cy="30" r="12" fill="'+COLORS.green+'"/><circle cx="50" cy="40" r="12" fill="'+COLORS.green+'"/><circle cx="80" cy="50" r="12" fill="'+COLORS.green+'"/><circle cx="30" cy="80" r="12" fill="'+COLORS.red+'"/><circle cx="70" cy="80" r="12" fill="'+COLORS.red+'"/><circle cx="30" cy="110" r="12" fill="'+COLORS.red+'"/><circle cx="70" cy="110" r="12" fill="'+COLORS.red+'"/>';
        for(var i=0; i<pos.length; i++) {
            var color = COLORS.blue;
            if((n===5 && i===2) || (n===3 && i===1)) color = COLORS.red;
            c += '<circle cx="'+pos[i][0]+'" cy="'+pos[i][1]+'" r="'+(n===9?11:13)+'" fill="'+color+'" />';
        }
        return c;
    }
    function drawTiao(n) {
        if (n===1) return '<path d="M50,30 Q70,30 75,50 Q80,70 50,70 Q30,70 30,50 Q30,30 50,30 M50,45 Q55,45 55,50 M35,60 L65,60 M50,70 L50,100 M40,100 L60,100" stroke="'+COLORS.green+'" stroke-width="3" fill="none" /><circle cx="55" cy="45" r="2" fill="black" />';
        var s = ""; var g = COLORS.green, b = COLORS.blue, r = COLORS.red;
        if (n===2) s += rect(45,20,g) + rect(45,70,b);
        else if (n===3) s += rect(25,20,g) + rect(45,50,r) + rect(65,80,g);
        else if (n===4) s += rect(30,20,g)+rect(60,20,g)+rect(30,70,b)+rect(60,70,b);
        else if (n===5) s += rect(20,20,g)+rect(70,20,g)+rect(45,50,r)+rect(20,80,b)+rect(70,80,b);
        else if (n===6) { for(var i=0;i<3;i++) s+=rect(30+i*20,30,g)+rect(30+i*20,70,b); }
        else if (n===8) { for(var i=0;i<4;i++) s+=rect(20+i*18,20,g)+rect(20+i*18,80,b); }
        else if (n===7) { for(var i=0;i<3;i++) s+=rect(30+i*20,20,g); for(var i=0;i<4;i++) s+=rect(20+i*18,70,g); }
        else if (n===9) { for(var j=0;j<3;j++) for(var i=0;i<3;i++) s+=rect(30+i*20,15+j*35, j===1?r:(j===0?g:b), 6, 25); }
        return s;
    }
    function rect(x,y,c,w,h) { return '<rect x="'+x+'" y="'+y+'" width="'+(w||8)+'" height="'+(h||30)+'" fill="'+c+'" />'; }

    // --- æ¸¸æˆé€»è¾‘ ---
    var game = {
        deck: [],
        players: [
            { id:0, score:10000, hand:[], melds:[], river:[], isAi:false, isLiang:false, tingList:[] },
            { id:1, score:10000, hand:[], melds:[], river:[], isAi:true, isLiang:false, tingList:[] },
            { id:2, score:10000, hand:[], melds:[], river:[], isAi:true, isLiang:false, tingList:[] }
        ],
        turn: 0, lastCard: -1, lastPlayer: -1, selectIdx: -1, hasDrawn: false, gangInfo: null
    };

    function updateScore() { document.getElementById('my-score').innerText = game.players[0].score; }

    function initGameSafe() {
        try {
            document.getElementById('start-overlay').style.display = 'none';
            document.getElementById('modal').style.display = 'none';
            document.getElementById('my-liang-tag').style.display = 'none';
            document.getElementById('p1-liang-tag').style.display = 'none';
            document.getElementById('p2-liang-tag').style.display = 'none';
            document.getElementById('p1-ting-box').style.display = 'none';
            document.getElementById('p2-ting-box').style.display = 'none';
            hideActions();

            var deck = [];
            for(var i=0;i<=20;i++) for(var k=0;k<4;k++) deck.push(i);
            for(var i=deck.length-1; i>0; i--) {
                var j=Math.floor(Math.random()*(i+1));
                var temp = deck[i]; deck[i] = deck[j]; deck[j] = temp;
            }
            game.deck = deck;

            for(var p=0; p<3; p++) {
                game.players[p].hand = [];
                game.players[p].melds = [];
                game.players[p].river = [];
                game.players[p].isLiang = false;
                game.players[p].tingList = [];
                for(var m=0; m<13; m++) game.players[p].hand.push(deck.pop());
                game.players[p].hand.sort(function(a,b){return a-b});
            }

            game.turn = 0; game.hasDrawn = false; game.selectIdx = -1;
            render(); updateScore();
            setMsg("æ¸¸æˆå¼€å§‹ï¼Œåº„å®¶æ‘¸ç‰Œ");
            setTimeout(performDraw, 600);
        } catch(e) { alert("å¯åŠ¨å¤±è´¥: " + e.message); }
    }

    function performDraw() {
        if(game.deck.length === 0) {
            showResult(false, "æµå±€", 0, "æ²¡ç‰Œäº†");
            return;
        }
        var p = game.players[game.turn];
        var c = game.deck.pop();
        p.hand.push(c);
        
        if(!p.isAi) {
            game.hasDrawn = true; game.selectIdx = -1;
            render();
            
            // äº®å€’åé€»è¾‘ï¼šé”å®šæ‰‹ç‰Œï¼Œåªèƒ½è‡ªæ‘¸æˆ–æ‰“å‡º
            if(p.isLiang) {
                setMsg("å·²äº®å€’ï¼Œè‡ªåŠ¨æ‘¸æ‰“...");
                if(checkWin(p.hand, p.melds)) {
                     showActions(['HU', 'PASS']); // PASSå°±æ˜¯æ‰“å‡º
                     setMsg("è‡ªæ‘¸ï¼");
                } else {
                    // å¼ºåˆ¶æ‰“å‡ºåˆšæ‘¸çš„ç‰Œ (å³æœ€åä¸€å¼ )
                    setTimeout(function() {
                        userDiscardForced(p.hand.length - 1);
                    }, 1000);
                }
                return;
            }

            // æ­£å¸¸é€»è¾‘
            if(checkWin(p.hand, p.melds)) {
                showActions(['HU', 'PASS']);
                setMsg("æ‘¸åˆ°å¥½ç‰Œäº†ï¼");
            } else {
                setMsg("è¯·å‡ºç‰Œ");
                // æ£€æŸ¥å¬ç‰Œæ‰æ˜¾ç¤ºäº®
                if(getTingTiles(p.hand, p.melds).length > 0) {
                    document.getElementById('btn-liang').style.display = 'block';
                }
                // æ£€æŸ¥æš—æ 
                var gangRes = checkSelfGang(p);
                if(gangRes) {
                    game.gangInfo = gangRes;
                    document.getElementById('btn-self-gang').style.display = 'block';
                }
            }
        } else {
            render();
            setMsg(game.turn===1?"ä¸‹å®¶æ€è€ƒ...":"ä¸Šå®¶æ€è€ƒ...");
            setTimeout(function(){ aiPlay(p); }, 800);
        }
    }

    // è¾…åŠ©ï¼šè·å–å¬å“ªäº›ç‰Œ
    function getTingTiles(hand, melds) {
        var tempHand = hand.slice();
        var tings = [];
        // éå†æ‰“å“ªå¼ 
        for(var i=0; i<tempHand.length; i++) {
            var discard = tempHand[i];
            var remain = tempHand.slice();
            remain.splice(i, 1);
            // éå†èƒ¡å“ªå¼ 
            for(var tile=0; tile<=20; tile++) {
                var test = remain.slice();
                test.push(tile);
                test.sort(function(a,b){return a-b});
                if(checkWin(test, melds)) {
                    // åªè¦èƒ½èƒ¡ä¸€å¼ ï¼Œå°±è¯´æ˜è¿™æ‰‹ç‰Œèƒ½å¬
                    // è¿™é‡Œæˆ‘ä»¬åªè¿”å›trueè¡¨ç¤ºèƒ½å¬ï¼Œä¸åšè¯¦ç»†åˆ†æ
                    return [1]; 
                }
            }
        }
        return [];
    }
    
    // è·å–è¿™æ‰‹ç‰Œèƒ¡ä»€ä¹ˆ (ç”¨äºAIäº®ç‰Œæ˜¾ç¤º)
    function getWinningTiles(hand, melds) {
        var wins = [];
        // æ‰‹ç‰Œæ˜¯13å¼ ï¼Œæ£€æŸ¥ç¼ºä»€ä¹ˆ
        for(var tile=0; tile<=20; tile++) {
            var test = hand.slice();
            test.push(tile);
            test.sort(function(a,b){return a-b});
            if(checkWin(test, melds)) wins.push(tile);
        }
        return wins;
    }

    function checkSelfGang(p) {
        for(var i=0; i<p.hand.length; i++) {
            var t = p.hand[i];
            for(var m=0; m<p.melds.length; m++) if(p.melds[m].type === 'peng' && p.melds[m].val === t) return {type:'BUGANG', val:t};
        }
        var counts = {};
        for(var i=0; i<p.hand.length; i++) counts[p.hand[i]] = (counts[p.hand[i]]||0)+1;
        for(var k in counts) if(counts[k] === 4) return {type:'ANGANG', val:parseInt(k)};
        return null;
    }

    function userSelfGang() {
        var p = game.players[0];
        var info = game.gangInfo;
        if(!info) return;
        if(info.type === 'ANGANG') {
            remove(p.hand, info.val, 4);
            p.melds.push({val: info.val, type:'gang'});
        } else {
            remove(p.hand, info.val, 1);
            for(var m=0; m<p.melds.length; m++) if(p.melds[m].val === info.val && p.melds[m].type === 'peng') { p.melds[m].type = 'gang'; break; }
        }
        game.gangInfo = null; document.getElementById('btn-self-gang').style.display = 'none';
        setMsg("æ ç‰Œï¼æ‘¸ä¸€å¼ ");
        render(); setTimeout(performDraw, 600);
    }

    function aiPlay(p) {
        if(checkWin(p.hand, p.melds)) {
            showResult(false, "ç”µè„‘èƒ¡äº†", -500, "ç”µè„‘è‡ªæ‘¸");
            return;
        }
        
        // AI äº®å€’é€»è¾‘ï¼šå¦‚æœå¬ç‰Œï¼Œå¤§æ¦‚ç‡äº®å€’
        if(!p.isLiang) {
            var wins = getWinningTiles(p.hand, p.melds);
            if(wins.length > 0 && Math.random() < 0.8) {
                p.isLiang = true;
                p.tingList = wins; // è®°å½•å®ƒèƒ¡ä»€ä¹ˆ
            }
        }
        
        // å¦‚æœAIäº®å€’äº†ï¼Œå¼ºåˆ¶æ‘¸æ‰“
        if(p.isLiang) {
             // åˆšæ‘¸çš„ç‰Œæ˜¯æœ€åä¸€å¼ 
             var card = p.hand.pop(); 
             // å¿…é¡»æ‰“å‡º
             game.lastCard = card; game.lastPlayer = game.turn; game.hasDrawn = false;
             showBig(card); render();
             checkResponse();
             return;
        }

        // æ­£å¸¸å‡ºç‰Œé€»è¾‘ + é˜²å®ˆ
        // é˜²å®ˆï¼šå¦‚æœç©å®¶(id=0)äº®äº†ï¼ŒAIç»å¯¹ä¸æ‰“ç©å®¶èƒ¡çš„ç‰Œ
        var dangerousTiles = [];
        if(game.players[0].isLiang) {
             dangerousTiles = getWinningTiles(game.players[0].hand, game.players[0].melds);
        }

        var counts = {};
        for(var i=0; i<p.hand.length; i++) counts[p.hand[i]] = (counts[p.hand[i]]||0)+1;
        
        var bestDiscard = -1;
        
        // å°è¯•æ‰¾ä¸€å¼ ä¸å±é™©çš„ç‰Œ
        for(var i=0; i<p.hand.length; i++) {
            var t = p.hand[i];
            if(dangerousTiles.indexOf(t) === -1) {
                // è¿™å¼ å®‰å…¨ï¼Œä¼˜å…ˆæ‰“å•å¼ 
                if(counts[t] === 1) {
                    if(t >= 18) { bestDiscard = i; break; } // å­—ç‰Œ
                    if(bestDiscard === -1) bestDiscard = i; // åºæ•°ç‰Œ
                }
            }
        }
        // å¦‚æœæ‰¾ä¸åˆ°å®‰å…¨çš„å•å¼ ï¼Œå°±éšæœºæ‰“ä¸€å¼ ä¸å±é™©çš„
        if(bestDiscard === -1) {
             for(var i=0; i<p.hand.length; i++) {
                 if(dangerousTiles.indexOf(p.hand[i]) === -1) {
                     bestDiscard = i; break;
                 }
             }
        }
        // å¦‚æœå…¨æ˜¯å±é™©ç‰Œ... æ²¡åŠæ³•ï¼Œåªèƒ½æ‹¼äº†(éšæœº)
        if(bestDiscard === -1) bestDiscard = Math.floor(Math.random()*p.hand.length);
        
        var card = p.hand.splice(bestDiscard, 1)[0];
        p.hand.sort(function(a,b){return a-b});
        
        game.lastCard = card; game.lastPlayer = game.turn; game.hasDrawn = false;
        showBig(card); render();
        checkResponse();
    }

    function checkResponse() {
        var card = game.lastCard;
        var from = game.lastPlayer;
        
        if(from !== 0) {
            var p0 = game.players[0];
            var acts = [];
            var checkH = p0.hand.slice(); checkH.push(card); checkH.sort(function(a,b){return a-b});
            if(checkWin(checkH, p0.melds)) acts.push('HU');
            
            // äº®å€’åä¸èƒ½ç¢°æ 
            if(!p0.isLiang) {
                var c = 0; for(var i=0;i<p0.hand.length;i++) if(p0.hand[i]===card) c++;
                if(c>=2) acts.push('PENG');
                if(c===3) acts.push('GANG');
            }
            
            if(acts.length>0) {
                acts.push('PASS');
                showActions(acts);
                setMsg("æ‚¨æœ‰æ“ä½œæœºä¼š");
                return; 
            }
        }
        var nextP = (from + 1) % 3;
        var prevP = (from + 2) % 3;
        if(tryAiResponse(nextP, card)) return;
        if(tryAiResponse(prevP, card)) return;
        game.players[from].river.push(card);
        nextTurn();
    }
    
    function tryAiResponse(aiId, card) {
        if(aiId === 0 || aiId === game.lastPlayer) return false; 
        var p = game.players[aiId];
        
        // 1. èƒ¡
        var checkH = p.hand.slice(); checkH.push(card); checkH.sort(function(a,b){return a-b});
        if(checkWin(checkH, p.melds)) {
             showResult(false, "ç”µè„‘èƒ¡äº†", -800, "ç”µè„‘æ‰ç‚®");
             return true;
        }
        
        // äº®å€’åä¸èƒ½ç¢°æ 
        if(p.isLiang) return false;

        var c = 0; for(var i=0;i<p.hand.length;i++) if(p.hand[i]===card) c++;
        if(c===3) { performAiAction(aiId, 'GANG', card); return true; }
        if(c>=2 && Math.random()<0.8) { performAiAction(aiId, 'PENG', card); return true; }
        return false;
    }
    
    function performAiAction(id, type, card) {
        var p = game.players[id];
        setMsg("ç”µè„‘" + (type==='PENG'?"ç¢°":"æ "));
        if(type==='PENG') {
            remove(p.hand, card, 2);
            p.melds.push({val:card, type:'peng'});
            game.turn = id;
            game.hasDrawn = true;
            document.getElementById('big-card').innerHTML = ''; 
            setTimeout(function(){
                // ç¢°åAIå‡ºç‰Œ (ç®€å•å‡ºç‰Œ)
                var discard = 0; 
                var dc = p.hand.splice(discard, 1)[0];
                p.hand.sort(function(a,b){return a-b});
                game.lastCard = dc; game.lastPlayer = id; game.hasDrawn = false;
                showBig(dc); render();
                checkResponse();
            }, 1000);
        }
        else if(type==='GANG') {
            remove(p.hand, card, 3);
            p.melds.push({val:card, type:'gang'});
            game.turn = id;
            document.getElementById('big-card').innerHTML = '';
            setTimeout(performDraw, 800);
        }
        render();
    }

    function nextTurn() {
        document.getElementById('big-card').innerHTML = '';
        game.turn = (game.turn + 1) % 3;
        render();
        setTimeout(performDraw, 500);
    }

    // å¼ºåˆ¶å‡ºç‰Œï¼ˆç”¨äºäº®å€’åï¼‰
    function userDiscardForced(idx) {
        var p = game.players[0];
        var card = p.hand.splice(idx, 1)[0];
        p.hand.sort(function(a,b){return a-b});
        hideActions();
        game.lastCard = card; game.lastPlayer = 0; game.hasDrawn = false;
        showBig(card); render();
        setTimeout(function() { checkResponse(); }, 500);
    }

    function userDiscard() {
        if(game.selectIdx === -1) return;
        var p = game.players[0];
        // äº®å€’æ ¡éªŒï¼šå¦‚æœä½ äº®å€’äº†ï¼Œä½ é€‰çš„ç‰Œå¿…é¡»æ˜¯åˆšæ‘¸çš„é‚£å¼ ï¼ˆæœ€åä¸€å¼ ï¼‰
        if(p.isLiang) {
            // å…¶å®ä»£ç é‡Œè‡ªåŠ¨å¤„ç†äº†ï¼Œè¿™é‡Œæ˜¯åŒé‡ä¿é™©
            if(game.selectIdx !== p.hand.length - 1) {
                setMsg("äº®å€’ååªèƒ½æ‰“æ‘¸åˆ°çš„ç‰Œ");
                return;
            }
        }
        userDiscardForced(game.selectIdx);
    }
    
    function userAction(act) {
        hideActions();
        document.getElementById('big-card').innerHTML = '';
        var p = game.players[0];
        var c = game.lastCard;
        if(act==='PASS') {
            // å¦‚æœäº®å€’äº†ï¼ŒPassæ„å‘³ç€æ‘¸åˆ°çš„ç‰Œè¦æ‰“å‡ºå»
            if(p.isLiang && game.turn === 0) {
                 userDiscardForced(p.hand.length - 1);
            } else {
                 // å“åº”åˆ«äººçš„ç‰ŒPass
                 var from = game.lastPlayer;
                 game.players[from].river.push(c);
                 nextTurn();
            }
        }
        else if(act==='PENG') {
            remove(p.hand, c, 2);
            p.melds.push({val:c, type:'peng'});
            game.turn=0; game.hasDrawn=true; game.selectIdx=-1;
            setMsg("ç¢°ï¼è¯·å‡ºç‰Œ");
            document.getElementById('btn-liang').style.display = 'none';
            render();
        }
        else if(act==='GANG') {
            remove(p.hand, c, 3);
            p.melds.push({val:c, type:'gang'});
            game.turn=0; 
            setMsg("æ ï¼æ‘¸ä¸€å¼ ");
            performDraw();
        }
        else if(act==='HU') {
            var fan = 1; var desc = "å¹³èƒ¡";
            var has4 = p.hand.indexOf(c-1) > -1;
            var has6 = p.hand.indexOf(c+1) > -1;
            if((c===4||c===13) && has4 && has6) { fan=2; desc="å¡äº”æ˜Ÿ"; }
            if(p.isLiang) { fan *= 2; desc += " + äº®å€’"; }
            if(game.lastPlayer !== 0 && game.lastPlayer !== -1) { desc += " (æ‰ç‚®)"; }
            showResult(true, "èƒ¡ç‰Œå•¦", 2000*fan, desc);
        }
    }
    
    function userLiang() {
        var p = game.players[0];
        p.isLiang = true;
        document.getElementById('my-liang-tag').style.display = 'inline-block';
        document.getElementById('btn-liang').style.display = 'none';
        setMsg("å·²äº®å€’ï¼ä¸‹å›åˆèµ·è‡ªåŠ¨æ‘¸æ‰“");
    }

    function onTileClick(idx, isNew) {
        if(game.turn!==0 || !game.hasDrawn) return;
        var p = game.players[0];
        var realIdx = isNew ? p.hand.length-1 : idx;
        
        // äº®å€’ååªèƒ½ç‚¹æœ€åä¸€å¼ 
        if(p.isLiang && realIdx !== p.hand.length - 1) return;

        if(game.selectIdx === realIdx) {
            userDiscard();
        } else {
            game.selectIdx = realIdx;
            render();
            document.getElementById('btn-out').style.display='block';
        }
    }

    // --- ç®—æ³• ---
    function checkWin(hand, melds) {
        var tiles = hand.slice(); 
        if(melds.length===0 && tiles.length===14 && check7(tiles)) return true;
        var counts = {}; 
        for(var i=0;i<tiles.length;i++) counts[tiles[i]] = (counts[tiles[i]]||0)+1;
        var pairs = [];
        for(var k in counts) if(counts[k]>=2) pairs.push(parseInt(k));
        for(var i=0; i<pairs.length; i++) {
            var p = pairs[i];
            var copy = tiles.slice();
            remove(copy, p, 2);
            if(checkSets(copy)) return true;
        }
        return false;
    }
    function check7(t){ for(var i=0;i<14;i+=2) if(t[i]!==t[i+1]) return false; return true; }
    function checkSets(t){
        if(t.length===0) return true;
        var f=t[0];
        var countF = 0; for(var i=0;i<t.length;i++) if(t[i]===f) countF++;
        if(countF>=3) {
            var c=t.slice(); remove(c,f,3);
            if(checkSets(c)) return true;
        }
        if(f<18) {
            var hasP1 = t.indexOf(f+1) > -1;
            var hasP2 = t.indexOf(f+2) > -1;
            if(hasP1 && hasP2) {
                 if(Math.floor(f/9)===Math.floor((f+2)/9)) {
                     var c=t.slice(); remove(c,f,1); remove(c,f+1,1); remove(c,f+2,1);
                     if(checkSets(c)) return true;
                 }
            }
        }
        return false;
    }
    function remove(arr, v, n){ for(var i=0;i<n;i++){ var idx=arr.indexOf(v); if(idx>-1) arr.splice(idx,1); } }

    function render() {
        document.getElementById('my-score').innerText = game.players[0].score;
        renderAi(1, 'p1-hand-area', 'p1-liang-tag', 'p1-melds', 'p1-ting-box', 'p1-ting-tiles');
        renderAi(2, 'p2-hand-area', 'p2-liang-tag', 'p2-melds', 'p2-ting-box', 'p2-ting-tiles');
        renderRiver('p1-river', game.players[1].river);
        renderRiver('p2-river', game.players[2].river);
        renderRiver('my-river', game.players[0].river);
        
        var p = game.players[0];
        var handDiv = document.getElementById('my-hand');
        var newDiv = document.getElementById('my-new');
        var meldDiv = document.getElementById('my-melds');
        handDiv.innerHTML=''; newDiv.innerHTML=''; meldDiv.innerHTML='';
        
        for(var i=0; i<p.melds.length; i++) {
            var m = p.melds[i];
            var g=document.createElement('div'); g.className='meld-group';
            var count = m.type==='gang'?4:3;
            for(var k=0;k<count;k++) g.appendChild(createTile(m.val, 'meld'));
            meldDiv.appendChild(g);
        }
        
        var len = p.hand.length;
        if(game.turn===0 && game.hasDrawn) len--;
        
        for(var i=0;i<len;i++) {
            var t = createTile(p.hand[i], 'normal');
            if(i===game.selectIdx) t.className += ' selected';
            (function(idx){ t.onclick = function(){onTileClick(idx,false)}; })(i);
            handDiv.appendChild(t);
        }
        if(game.turn===0 && game.hasDrawn) {
            var idx = p.hand.length-1;
            var t = createTile(p.hand[idx], 'normal');
            if(idx===game.selectIdx) t.className += ' selected';
            t.onclick = function(){onTileClick(idx,true)};
            newDiv.appendChild(t);
        }
    }
    
    function renderAi(id, elId, tagId, meldId, tingBoxId, tingTilesId) {
        var el = document.getElementById(elId);
        var tag = document.getElementById(tagId);
        var mEl = document.getElementById(meldId);
        var tBox = document.getElementById(tingBoxId);
        var tTiles = document.getElementById(tingTilesId);
        var p = game.players[id];
        
        mEl.innerHTML = '';
        for(var i=0; i<p.melds.length; i++) {
             var m = p.melds[i];
             var g=document.createElement('div'); g.className='meld-group';
             var count = m.type==='gang'?4:3;
             for(var k=0;k<count;k++) g.appendChild(createTile(m.val, 'meld'));
             mEl.appendChild(g);
        }

        if(p.isLiang) {
            tag.style.display = 'inline-block';
            el.innerHTML = '';
            el.className = 'opp-hand opp-hand-open';
            for(var i=0; i<p.hand.length; i++) {
                var t = createTile(p.hand[i], 'normal');
                t.className += ' tile-small-face';
                el.appendChild(t);
            }
            // æ˜¾ç¤ºèƒ¡ä»€ä¹ˆ
            tBox.style.display = 'flex';
            tTiles.innerHTML = '';
            for(var i=0; i<p.tingList.length; i++) {
                var tiny = createTile(p.tingList[i], 'tiny');
                tTiles.appendChild(tiny);
            }
        } else {
            tag.style.display = 'none';
            tBox.style.display = 'none';
            el.className = 'opp-hand';
            el.innerText = "å‰©" + p.hand.length + "å¼ ";
        }
    }
    
    function renderRiver(id, river) {
        var d = document.getElementById(id); d.innerHTML='';
        for(var i=0; i<river.length; i++) d.appendChild(createTile(river[i], 'dropped'));
    }
    function createTile(val, type) {
        var div = document.createElement('div');
        div.className = 'tile';
        if(type==='dropped') div.className += ' tile-dropped';
        if(type==='meld') div.className += ' tile-meld';
        if(type==='big') div.className += ' tile-big';
        if(type==='tiny') div.className += ' tile-tiny';
        var face = document.createElement('div');
        face.className = 'tile-face';
        face.innerHTML = getSvg(val);
        div.appendChild(face);
        return div;
    }
    function showBig(val) {
        var b = document.getElementById('big-card'); b.innerHTML='';
        b.appendChild(createTile(val, 'big'));
    }
    function showActions(acts) {
        var g = document.getElementById('btn-group'); g.innerHTML='';
        var bo = document.createElement('button'); bo.className='btn btn-out'; bo.id='btn-out'; bo.innerText='å‡ºç‰Œ'; bo.onclick=userDiscard; g.appendChild(bo);
        
        // åªæœ‰äº®å€’åè‡ªæ‘¸æ—¶ï¼ŒPASSæ˜¾ç¤ºä¸º"æ‰“å‡º"
        var isLiangPass = game.players[0].isLiang && acts.indexOf('HU') > -1;

        for(var i=0; i<acts.length; i++) {
            (function(act){
                var b=document.createElement('button'); b.className='btn';
                if(act==='HU') { b.innerText="èƒ¡ç‰Œ"; b.className+=' btn-hu';}
                if(act==='PENG') { b.innerText="ç¢°"; b.className+=' btn-peng';}
                if(act==='GANG') { b.innerText="æ "; b.className+=' btn-gang';}
                if(act==='PASS') { 
                    b.innerText = isLiangPass ? "æ‰“å‡º" : "è¿‡"; 
                    b.className+=' btn-pass';
                }
                b.onclick = function(){ userAction(act); };
                g.appendChild(b);
            })(acts[i]);
        }
    }
    function hideActions() {
         var g = document.getElementById('btn-group'); g.innerHTML='';
         var bl = document.createElement('button'); bl.className='btn btn-liang'; bl.id='btn-liang'; bl.innerText='äº®å€’'; bl.onclick=userLiang; g.appendChild(bl);
         var bg = document.createElement('button'); bg.className='btn btn-gang'; bg.id='btn-self-gang'; bg.innerText='æ '; bg.onclick=userSelfGang; g.appendChild(bg);
         var bo = document.createElement('button'); bo.className='btn btn-out'; bo.id='btn-out'; bo.innerText='å‡ºç‰Œ'; bo.onclick=userDiscard; g.appendChild(bo);
         bl.style.display = 'none';
         bg.style.display = 'none';
    }
    function showResult(win, title, score, desc) {
        var m = document.getElementById('modal'); m.style.display='flex';
        document.getElementById('res-title').innerText = title;
        document.getElementById('res-desc').innerText = desc;
        var s = document.getElementById('res-score');
        s.innerText = (score>0?"+":"")+score;
        s.style.color = score>0?"#d32f2f":"#388e3c";
        game.players[0].score += score;
        document.getElementById('my-score').innerText=game.players[0].score;
    }
    function setMsg(txt) { document.getElementById('msg-text').innerText = txt; }
</script>
</body>
</html>